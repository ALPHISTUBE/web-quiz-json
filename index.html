<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JSON Quiz Exam with Category Filters & Help & Convert</title>
<style>
  * {
    box-sizing: border-box;
  }
  body {
    margin:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background:#f0f2f5; color:#222;
    display:flex; flex-direction: column; min-height: 100vh;
  }
  h2 {
    margin:0 0 10px 0;
    font-weight: 600;
  }
  button {
    cursor:pointer;
    background: #4a90e2;
    color: white;
    border:none;
    padding: 10px 16px;
    border-radius: 4px;
    font-weight: 600;
    transition: background 0.3s;
  }
  button:hover:not(:disabled) {
    background: #357ABD;
  }
  button:disabled {
    opacity: 0.5; cursor: not-allowed;
  }
  input[type=number] {
    width: 60px;
    padding: 6px 8px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  label {
    font-weight: 600;
    margin-right: 8px;
  }
  /* Container */
  #app {
    max-width: 1024px;
    margin: 0 auto;
    padding: 15px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
  }
  /* Toast container */
  #toast-container {
    position: fixed;
    top: 20px; right: 20px;
    z-index: 9999;
  }
  .toast {
    background: #333;
    color: white;
    padding: 12px 20px;
    margin-bottom: 10px;
    border-radius: 6px;
    opacity: 0;
    animation: fadeInOut 4s forwards;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  .toast.success {
    background: #4CAF50;
  }
  .toast.error {
    background: #E53935;
  }
  @keyframes fadeInOut {
    0% {opacity:0; transform: translateY(-10px);}
    10%, 90% {opacity:1; transform: translateY(0);}
    100% {opacity:0; transform: translateY(-10px);}
  }
  /* File Upload Section */
  #upload-section {
    border: 2px dashed #aaa;
    padding: 30px;
    text-align: center;
    border-radius: 8px;
    background: white;
    transition: border-color 0.3s;
  }
  #upload-section.dragover {
    border-color: #4a90e2;
    background: #e7f0ff;
  }
  #upload-section input[type=file] {
    display: none;
  }
  #upload-section label {
    display: inline-block;
    padding: 12px 18px;
    background: #4a90e2;
    color: white;
    border-radius: 4px;
    font-weight: 600;
    margin-top: 10px;
    cursor: pointer;
    user-select: none;
  }
  /* Tabs */
  .tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }
  .tab-btn {
    flex: 1;
    padding: 12px 0;
    border-radius: 6px;
    border: 1px solid #4a90e2;
    background: white;
    color: #4a90e2;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
    text-align: center;
    user-select: none;
  }
  .tab-btn.active {
    background: #4a90e2;
    color: white;
    cursor: default;
  }
  .tab-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  /* Section content */
  .tab-content {
    background: white;
    border-radius: 8px;
    padding: 15px 20px;
    box-shadow: 0 1px 8px rgba(0,0,0,0.1);
    min-height: 500px;
    overflow-y: auto;
    flex-grow: 1;
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  /* Blur overlay on content when exam running */
  .blurred {
    filter: blur(4px);
    pointer-events: none;
    user-select: none;
  }
  /* All Questions */
  #all-questions {
    font-size: 14px;
  }
  .qa-item {
    border-bottom: 1px solid #eee;
    padding: 8px 0;
  }
  .qa-item:last-child {
    border-bottom: none;
  }
  .qa-q {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
  }
  .qa-category-badge {
    background: #4a90e2;
    color: white;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 13px;
    user-select: none;
    white-space: nowrap;
  }
  .qa-a {
    color: #555;
    margin-left: 12px;
  }
  /* Exam Section */
  #exam-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 15px;
    align-items: center;
  }
  #exam-controls > * {
    flex-shrink: 0;
  }
  #exam-area {
    font-size: 16px;
  }
  #exam-question {
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
  }
  #exam-answer {
    width: 100%;
    padding: 8px 10px;
    font-size: 16px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  #exam-timer {
    font-weight: 700;
    font-size: 18px;
    color: #4a90e2;
    margin-bottom: 10px;
  }
  #exam-result {
    margin-top: 15px;
    font-size: 16px;
    font-weight: 600;
  }
  /* Review Section */
  #review-filters {
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
  }
  #review-list {
    font-size: 14px;
  }
  .review-item {
    border-bottom: 1px solid #eee;
    padding: 6px 0;
  }
  .review-item:last-child {
    border-bottom: none;
  }
  .filter-btn {
    padding: 6px 12px;
    border-radius: 4px;
    border: 1px solid #4a90e2;
    background: white;
    color: #4a90e2;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
  }
  .filter-btn.active {
    background: #4a90e2;
    color: white;
  }
  /* Category Tag Selector */
  .category-selector-container {
    margin-bottom: 12px;
  }
  .category-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 6px;
  }
  .category-tag {
    background: #4a90e2;
    color: white;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 14px;
    display: flex;
    align-items: center;
    user-select: none;
  }
  .category-tag .remove-tag {
    margin-left: 6px;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
  }
  .clear-categories-btn {
    cursor: pointer;
    font-weight: 600;
    color: #357ABD;
    background: none;
    border: none;
    padding: 0;
    user-select: none;
  }
  .clear-categories-btn:hover {
    text-decoration: underline;
  }
  /* Category dropdown */
  .category-dropdown {
    position: relative;
    display: inline-block;
    width: 100%;
    max-width: 300px;
  }
  .category-dropdown-toggle {
    width: 100%;
    padding: 8px 10px;
    font-size: 16px;
    border: 1px solid #4a90e2;
    border-radius: 6px;
    background: white;
    cursor: pointer;
    user-select: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .category-dropdown-list {
    position: absolute;
    top: 110%;
    left: 0;
    width: 100%;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #4a90e2;
    background: white;
    border-radius: 6px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    z-index: 1000;
    display: none;
  }
  .category-dropdown-list.show {
    display: block;
  }
  .category-dropdown-list li {
    list-style: none;
    padding: 8px 12px;
    cursor: pointer;
    user-select: none;
  }
  .category-dropdown-list li:hover {
    background: #e6f0ff;
  }
  /* Help & Convert JSON tab layout */
  #help-content {
    display: flex;
    gap: 20px;
    margin-top: 15px;
  }
  #help-sample-json {
    flex: 1;
    background: #1e1e1e;
    color: #d4d4d4;
    font-family: Consolas, monospace;
    font-size: 14px;
    line-height: 1.4;
    border-radius: 6px;
    padding: 12px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    min-height: 320px;
    max-height: 320px;
    outline: none;
    border: 1px solid #333;
    resize: vertical;
  }
  #help-sample-json-highlight {
    flex: 1;
    background: #252526;
    border: 1px solid #333;
    color: #d4d4d4;
    font-family: Consolas, monospace;
    font-size: 14px;
    padding: 12px;
    border-radius: 6px;
    white-space: pre-wrap;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 8px;
    user-select: text;
  }
  #help-controls {
    width: 280px;
    background: #fff;
    border-radius: 6px;
    padding: 15px 20px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
  }
  #help-controls label {
    font-weight: 600;
    margin: 10px 0 4px;
    display: block;
  }
  #help-controls select, #help-controls input[type=checkbox] {
    margin-bottom: 8px;
  }
  #help-controls button {
    margin-top: 12px;
    font-weight: 600;
    padding: 10px;
  }
  /* Syntax Highlighting for JSON */
  .json-key {
    color: #9cdcfe;
  }
  .json-string {
    color: #ce9178;
  }
  .json-number {
    color: #b5cea8;
  }
  .json-boolean {
    color: #569cd6;
  }
  .json-null {
    color: #569cd6;
    font-style: italic;
  }
  .json-error {
    color: #f44747;
    font-weight: bold;
  }
  /* Documentation Section */
  #documentation {
    margin-top: 25px;
    background: white;
    border-radius: 8px;
    padding: 15px 20px;
    box-shadow: 0 1px 8px rgba(0,0,0,0.1);
    font-size: 14px;
    color: #222;
  }
  #documentation h3 {
    margin-top: 0;
  }
  #documentation pre {
    background: #1e1e1e;
    color: #d4d4d4;
    font-family: Consolas, monospace;
    font-size: 14px;
    padding: 12px;
    border-radius: 6px;
    overflow-x: auto;
  }
  /* Accessibility helper: hide from screen reader */
  .sr-only {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0,0,0,0) !important;
    border: 0 !important;
  }

  .json-key {
    color: #9cdcfe;
  }
  .json-string {
    color: #ce9178;
  }
  .json-number {
    color: #b5cea8;
  }
  .json-boolean {
    color: #569cd6;
  }
  .json-null {
    color: #569cd6;
    font-style: italic;
  }

</style>
</head>
<body>
<div id="app">

    <!-- Upload Section -->
    <div style="display: flex; gap: 20px; max-width: 900px; margin: 0 auto; align-items: center;">
        <div id="upload-section" tabindex="0"
            style="flex: 0 0 45%; border: 2px dashed #aaa; padding: 30px; text-align: center;
                    border-radius: 8px; background: white; box-sizing: border-box; min-height: 180px;
                    display: flex; flex-direction: column; justify-content: center;">

            <div style="margin-bottom: 12px;">Drag & Drop your <b>.json</b> quiz file here or</div>

            <label for="file-input" style="display: inline-block; padding: 12px 18px; background: #4a90e2;
                                        color: white; border-radius: 4px; font-weight: 600; cursor: pointer; user-select: none;">
            Select JSON File
            </label>

            <input id="file-input" type="file" accept=".json" style="display: none;" />
        </div>
        <pre style="flex: 0 0 50%; background: #1e1e1e; color: #d4d4d4; ">
[
    {
        <span class="json-key">"category"</span>: <span class="json-string">"Math"</span>,
        <span class="json-key">"question"</span>: <span class="json-string">"What is 2 + 2?"</span>,
        <span class="json-key">"answer"</span>: <span class="json-string">"4"</span>
    },
    {
        <span class="json-key">"category"</span>: <span class="json-string">"Science"</span>,
        <span class="json-key">"question"</span>: <span class="json-string">"What is H2O?"</span>,
        <span class="json-key">"answer"</span>: <span class="json-string">"Water"</span>
    }
]
        </pre>
    </div>




  <!-- Tabs -->
  <div class="tabs" role="tablist" aria-label="Main content tabs">
    <button role="tab" aria-selected="true" aria-controls="tab-all" id="tab-btn-all" class="tab-btn active">All</button>
    <button role="tab" aria-selected="false" aria-controls="tab-quiz" id="tab-btn-quiz" class="tab-btn">Quiz</button>
    <button role="tab" aria-selected="false" aria-controls="tab-recent" id="tab-btn-recent" class="tab-btn">Recent</button>
    <button role="tab" aria-selected="false" aria-controls="tab-help" id="tab-btn-help" class="tab-btn">Help & Convert</button>
  </div>

  <!-- Tab Contents -->
  <section id="tab-all" class="tab-content active" role="tabpanel" tabindex="0" aria-labelledby="tab-btn-all" aria-hidden="false" >
    <h2>All Questions</h2>
    <div class="category-selector-container">
      <div class="category-tags" id="category-tags-all"></div>
      <div class="category-dropdown" id="category-dropdown-all" tabindex="0" aria-label="Select categories for All questions filter">
        <div class="category-dropdown-toggle" id="dropdown-toggle-all" aria-haspopup="listbox" aria-expanded="false" role="button">
          Select categories...
          <span aria-hidden="true">&#x25BC;</span>
        </div>
        <ul class="category-dropdown-list" id="dropdown-list-all" role="listbox" tabindex="-1"></ul>
      </div>
      <button class="clear-categories-btn" id="clear-categories-all" aria-label="Clear all categories for All questions">Clear All</button>
    </div>
    <div id="all-questions" role="list" aria-live="polite" aria-atomic="true">
      <p>No questions loaded.</p>
    </div>
  </section>

  <section id="tab-quiz" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-btn-quiz" aria-hidden="true">
    <h2>Exam</h2>
    <div class="category-selector-container">
      <div class="category-tags" id="category-tags-quiz"></div>
      <div class="category-dropdown" id="category-dropdown-quiz" tabindex="0" aria-label="Select categories for Quiz questions filter">
        <div class="category-dropdown-toggle" id="dropdown-toggle-quiz" aria-haspopup="listbox" aria-expanded="false" role="button">
          Select categories...
          <span aria-hidden="true">&#x25BC;</span>
        </div>
        <ul class="category-dropdown-list" id="dropdown-list-quiz" role="listbox" tabindex="-1"></ul>
      </div>
      <button class="clear-categories-btn" id="clear-categories-quiz" aria-label="Clear all categories for Quiz questions">Clear All</button>
    </div>
    <div id="exam-controls" aria-label="Exam settings">
      <label for="qus-count">Questions:</label>
      <input type="number" id="qus-count" min="1" max="100" value="10" aria-describedby="qus-count-desc" />
      <span id="qus-count-desc" class="sr-only">Set number of questions for exam (1 to 100)</span>

      <label for="time-per-qus">Seconds per question:</label>
      <input type="number" id="time-per-qus" min="1" max="300" value="20" aria-describedby="time-per-qus-desc" />
      <span id="time-per-qus-desc" class="sr-only">Set time limit in seconds per question</span>

      <label for="mode-select">Mode:</label>
      <select id="mode-select" aria-label="Exam mode">
        <option value="timed" selected>Timed</option>
        <option value="notimed">No Time Limit</option>
      </select>

      <label><input type="checkbox" id="no-repeat" /> Don't repeat same question</label>

      <label><input type="checkbox" id="repeat-incorrect" /> Repeat incorrect only</label>

      <button id="start-exam">Start Exam</button>
      <button id="skip-question" style="display:none;">Skip Question</button>
      <button id="stop-exam" style="display:none; background:#E53935;">Stop Exam</button>
    </div>

    <div id="exam-area" aria-live="polite" aria-atomic="true" style="min-height:120px;">
      <!-- Dynamic Exam Content Goes Here -->
    </div>
    <div id="exam-result" aria-live="polite"></div>
  </section>

  <section id="tab-recent" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-btn-recent" aria-hidden="true">
    <h2>Review Questions</h2>
    <div class="category-selector-container">
      <div class="category-tags" id="category-tags-recent"></div>
      <div class="category-dropdown" id="category-dropdown-recent" tabindex="0" aria-label="Select categories for Recent questions filter">
        <div class="category-dropdown-toggle" id="dropdown-toggle-recent" aria-haspopup="listbox" aria-expanded="false" role="button">
          Select categories...
          <span aria-hidden="true">&#x25BC;</span>
        </div>
        <ul class="category-dropdown-list" id="dropdown-list-recent" role="listbox" tabindex="-1"></ul>
      </div>
      <button class="clear-categories-btn" id="clear-categories-recent" aria-label="Clear all categories for Recent questions">Clear All</button>
    </div>
    <div id="review-filters" role="group" aria-label="Filter questions">
      <button class="filter-btn active" data-filter="all" aria-pressed="true">All Recent</button>
      <button class="filter-btn" data-filter="incorrect" aria-pressed="false">Incorrect</button>
      <button class="filter-btn" data-filter="correct" aria-pressed="false">Correct</button>
    </div>
    <div id="review-list" role="list" aria-live="polite" aria-atomic="true">
      <p>No recent questions.</p>
    </div>
  </section>

  <section id="tab-help" class="tab-content" role="tabpanel" tabindex="0" aria-labelledby="tab-btn-help" aria-hidden="true">
    <h2>Help & Convert JSON</h2>
    <div id="help-content">
      <div id="help-editors" style="display: flex; flex-direction: column; gap: 10px; flex: 1;">
        <textarea id="help-sample-json" spellcheck="false" aria-label="JSON Input for conversion" 
        style="height: 300px; font-family: monospace; font-size: 14px; background: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 6px; border: 1px solid #4a90e2;">
[
    {
        "category": "Math",
        "question": "What is 2 + 2?",
        "answer": "4"
    },
    {
        "category": "Science",
        "question": "What is H2O?",
        "answer": "Water"
    }
]
        </textarea>


        <pre id="help-sample-json-highlight" aria-live="polite" aria-atomic="true" aria-label="Syntax highlighted JSON output"
        style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 14px; background: #1e1e1e; color: #d4d4d4; padding: 10px; border-radius: 6px; border: 1px solid #4a90e2;"></pre>
    </div>
      <div id="help-controls" role="form" aria-label="JSON key mapping and conversion controls">
        <label for="category-key">Category key:</label>
        <select id="category-key" aria-describedby="category-help">
          <option>category</option>
        </select>
        <label><input type="checkbox" id="category-use-key" /> Use key name as category value</label>

        <label for="question-key">Question key:</label>
        <select id="question-key" aria-describedby="question-help">
          <option>question</option>
        </select>
        <label><input type="checkbox" id="question-use-key" /> Use key name as question value</label>

        <label for="answer-key">Answer key:</label>
        <select id="answer-key" aria-describedby="answer-help">
          <option>answer</option>
        </select>
        <label><input type="checkbox" id="answer-use-key" /> Use key name as answer value</label>

        <label for="help-file-input">Or upload JSON file:</label>
        <input type="file" id="help-file-input" accept=".json" />

        <button id="convert-load-json">Convert & Load JSON</button>
      </div>
    </div>
    <div id="documentation" aria-live="polite" aria-atomic="true" style="font-size:14px; color:#222;">
        <h3>Documentation</h3>

        <h5>Drag & Drop/upload json</h5>
        <p>To use this application, you can either drag and drop a <code>.json</code> file into the designated area or click the "Select JSON File" button to choose a file from your computer.</p>
        <p>This format is required to use upload or drag & drop functionality:</p>
        <pre>
[
    {
        <span class="json-key">"category"</span>: <span class="json-string">"Math"</span>,
        <span class="json-key">"question"</span>: <span class="json-string">"What is 2 + 2?"</span>,
        <span class="json-key">"answer"</span>: <span class="json-string">"4"</span>
    },
    {
        <span class="json-key">"category"</span>: <span class="json-string">"Science"</span>,
        <span class="json-key">"question"</span>: <span class="json-string">"What is H2O?"</span>,
        <span class="json-key">"answer"</span>: <span class="json-string">"Water"</span>
    }
]
        </pre>

        <h5>Format B: Object with categories as keys and question arrays as values</h5>
        <pre>
[
    <span class="json-string">"Math"</span>: [
        {
        <span class="json-key">"question"</span>: <span class="json-string">"What is 2 + 2?"</span>,
        <span class="json-key">"answer"</span>: <span class="json-string">"4"</span>
        }
    ],
    <span class="json-string">"Science"</span>: [
        {
        <span class="json-key">"question"</span>: <span class="json-string">"What is H2O?"</span>,
        <span class="json-key">"answer"</span>: <span class="json-string">"Water"</span>
        }
    ]
]
        </pre>

        <p>Using the key mapping checkboxes, you can tell the tool to use the key names themselves as values if your JSON structure uses keys as categories or questions.</p>

        <hr/>

        <h4>How to use each tab</h4>

        <ul>
            <li><strong>All Tab:</strong> Displays all loaded questions. You can filter questions by categories using the category selector. This is useful for reviewing the entire question bank.</li>
            <li><strong>Quiz Tab:</strong> Configure and start your exam here. Set the number of questions, time per question, and exam mode. Start the exam and answer questions one by one. You can skip questions or stop the exam anytime.</li>
            <li><strong>Recent Tab:</strong> Review your recent quiz attempts. You can filter recent questions by correct or incorrect answers to focus on weak areas.</li>
            <li><strong>Help & Convert Tab:</strong> Paste or upload your JSON quiz data here. Use key mapping options to match your JSON structure and convert it into the app's internal format.</li>
        </ul>

        <hr/>

        <h4>Starting an Exam</h4>
        <ol>
            <li>Load your JSON questions via the Help & Convert tab by pasting JSON or uploading a file and clicking <em>Convert & Load JSON</em>.</li>
            <li>Go to the Quiz tab and select the number of questions you want and set timing options.</li>
            <li>Use category filters to limit questions to specific topics.</li>
            <li>Click <em>Start Exam</em> to begin.</li>
            <li>Answer the questions in the input box and submit. Use <em>Skip Question</em> if unsure.</li>
            <li>After completing, see your score and statistics.</li>
        </ol>

        <hr/>

        <h4>Additional Notes</h4>
        <ul>
            <li>Ensure your JSON is valid and matches one of the accepted formats for smooth loading.</li>
            <li>You can save your progress in the browser's local storage.</li>
            <li>Use category tags to focus on particular areas during review or quiz.</li>
            <li>The application supports repeating only incorrect questions in quizzes.</li>
        </ul>
    </div>
  </section>

</div>

<div id="toast-container" role="alert" aria-live="assertive" aria-atomic="true"></div>

<script>
(() => {
  // Elements
  const uploadSection = document.getElementById('upload-section');
  const fileInput = document.getElementById('file-input');
  const allQuestionsDiv = document.getElementById('all-questions');
  const qusCountInput = document.getElementById('qus-count');
  const timePerQusInput = document.getElementById('time-per-qus');
  const modeSelect = document.getElementById('mode-select');
  const noRepeatCheckbox = document.getElementById('no-repeat');
  const repeatIncorrectCheckbox = document.getElementById('repeat-incorrect');
  const startExamBtn = document.getElementById('start-exam');
  const skipQuestionBtn = document.getElementById('skip-question');
  const stopExamBtn = document.getElementById('stop-exam');
  const examArea = document.getElementById('exam-area');
  const examResult = document.getElementById('exam-result');
  const reviewFilters = document.querySelectorAll('#review-filters .filter-btn');
  const reviewList = document.getElementById('review-list');
  const toastContainer = document.getElementById('toast-container');

  const tabButtons = {
    all: document.getElementById('tab-btn-all'),
    quiz: document.getElementById('tab-btn-quiz'),
    recent: document.getElementById('tab-btn-recent'),
    help: document.getElementById('tab-btn-help'),
  };
  const tabContents = {
    all: document.getElementById('tab-all'),
    quiz: document.getElementById('tab-quiz'),
    recent: document.getElementById('tab-recent'),
    help: document.getElementById('tab-help'),
  };

  // Category elements
  const categoryTags = {
    all: document.getElementById('category-tags-all'),
    quiz: document.getElementById('category-tags-quiz'),
    recent: document.getElementById('category-tags-recent'),
  };
  const categoryDropdownToggles = {
    all: document.getElementById('dropdown-toggle-all'),
    quiz: document.getElementById('dropdown-toggle-quiz'),
    recent: document.getElementById('dropdown-toggle-recent'),
  };
  const categoryDropdownLists = {
    all: document.getElementById('dropdown-list-all'),
    quiz: document.getElementById('dropdown-list-quiz'),
    recent: document.getElementById('dropdown-list-recent'),
  };
  const clearCategoryBtns = {
    all: document.getElementById('clear-categories-all'),
    quiz: document.getElementById('clear-categories-quiz'),
    recent: document.getElementById('clear-categories-recent'),
  };

  // Help & Convert elements
  const helpJsonTextarea = document.getElementById('help-sample-json');
  const helpJsonHighlight = document.getElementById('help-sample-json-highlight');
  const helpCategoryKeySelect = document.getElementById('category-key');
  const helpCategoryUseKey = document.getElementById('category-use-key');
  const helpQuestionKeySelect = document.getElementById('question-key');
  const helpQuestionUseKey = document.getElementById('question-use-key');
  const helpAnswerKeySelect = document.getElementById('answer-key');
  const helpAnswerUseKey = document.getElementById('answer-use-key');
  const helpFileInput = document.getElementById('help-file-input');
  const convertLoadBtn = document.getElementById('convert-load-json');

  // Storage keys
  const STORAGE_KEYS = {
    QUESTIONS: 'quiz_questions',
    SETTINGS: 'quiz_settings',
    EXAM_STATE: 'quiz_exam_state',
    RECENT_IDS: 'quiz_recent_ids',
    INCORRECT_IDS: 'quiz_incorrect_ids',
    IS_EXAM_RUNNING: 'is_exam_running',
    SELECTED_CATEGORIES_ALL: 'selected_categories_all',
    SELECTED_CATEGORIES_QUIZ: 'selected_categories_quiz',
    SELECTED_CATEGORIES_RECENT: 'selected_categories_recent'
  };

  // State
  let questions = [];
  let settings = {
    qusCount: 10,
    timePerQus: 20,
    mode: 'timed',
    noRepeat: false,
    repeatIncorrect: false
  };
  let examState = null; // Holds exam progress: currentIdx, answers, times, completed
  let recentIds = [];
  let incorrectIds = [];
  let selectedCategories = {
    all: [],
    quiz: [],
    recent: []
  };

  let examTimer = null;
  let timeLeft = 0;

  // Utility: Toast
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    toastContainer.appendChild(toast);
    setTimeout(() => {
      toast.remove();
    }, 4000);
  }

  // Save to Local Storage
  function saveToStorage() {
    localStorage.setItem(STORAGE_KEYS.QUESTIONS, JSON.stringify(questions));
    localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
    localStorage.setItem(STORAGE_KEYS.RECENT_IDS, JSON.stringify(recentIds));
    localStorage.setItem(STORAGE_KEYS.INCORRECT_IDS, JSON.stringify(incorrectIds));
    localStorage.setItem(STORAGE_KEYS.SELECTED_CATEGORIES_ALL, JSON.stringify(selectedCategories.all));
    localStorage.setItem(STORAGE_KEYS.SELECTED_CATEGORIES_QUIZ, JSON.stringify(selectedCategories.quiz));
    localStorage.setItem(STORAGE_KEYS.SELECTED_CATEGORIES_RECENT, JSON.stringify(selectedCategories.recent));
    if (examState) {
      localStorage.setItem(STORAGE_KEYS.EXAM_STATE, JSON.stringify(examState));
      localStorage.setItem(STORAGE_KEYS.IS_EXAM_RUNNING, 'true');
    } else {
      localStorage.removeItem(STORAGE_KEYS.EXAM_STATE);
      localStorage.setItem(STORAGE_KEYS.IS_EXAM_RUNNING, 'false');
    }
  }

  // Load from Local Storage
  function loadFromStorage() {
    try {
      const qs = JSON.parse(localStorage.getItem(STORAGE_KEYS.QUESTIONS));
      if (Array.isArray(qs)) questions = qs;
    } catch {}
    try {
      const st = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS));
      if (st && typeof st === 'object') settings = {...settings, ...st};
    } catch {}
    try {
      const rec = JSON.parse(localStorage.getItem(STORAGE_KEYS.RECENT_IDS));
      if (Array.isArray(rec)) recentIds = rec;
    } catch {}
    try {
      const inc = JSON.parse(localStorage.getItem(STORAGE_KEYS.INCORRECT_IDS));
      if (Array.isArray(inc)) incorrectIds = inc;
    } catch {}
    try {
      const es = JSON.parse(localStorage.getItem(STORAGE_KEYS.EXAM_STATE));
      if (es && typeof es === 'object') examState = es;
    } catch {}
    try {
      const catAll = JSON.parse(localStorage.getItem(STORAGE_KEYS.SELECTED_CATEGORIES_ALL));
      if (Array.isArray(catAll)) selectedCategories.all = catAll;
    } catch {}
    try {
      const catQuiz = JSON.parse(localStorage.getItem(STORAGE_KEYS.SELECTED_CATEGORIES_QUIZ));
      if (Array.isArray(catQuiz)) selectedCategories.quiz = catQuiz;
    } catch {}
    try {
      const catRecent = JSON.parse(localStorage.getItem(STORAGE_KEYS.SELECTED_CATEGORIES_RECENT));
      if (Array.isArray(catRecent)) selectedCategories.recent = catRecent;
    } catch {}
  }

  // Escape HTML
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m]);
  }

  // Validate quiz JSON: array of {question:string, answer:string, category:string}
  function validateQuizJson(data) {
    if (!Array.isArray(data)) return false;
    for (const item of data) {
      if (typeof item !== 'object') return false;
      if (!item.question || !item.answer || !item.category) return false;
      if (typeof item.question !== 'string' || typeof item.answer !== 'string' || typeof item.category !== 'string') return false;
    }
    return true;
  }

  // Assign IDs (if missing)
  function assignIds(qs) {
    return qs.map((q, i) => ({ id: i + 1, question: q.question, answer: q.answer, category: q.category }));
  }

  // Get unique categories from questions
  function getUniqueCategories() {
    const cats = new Set();
    questions.forEach(q => cats.add(q.category));
    return Array.from(cats).sort();
  }

  // Render category dropdown list for a tab
  function renderCategoryDropdownList(tab) {
    const listEl = categoryDropdownLists[tab];
    listEl.innerHTML = '';
    const cats = getUniqueCategories();
    cats.forEach(cat => {
      const li = document.createElement('li');
      li.textContent = cat;
      li.setAttribute('role', 'option');
      li.tabIndex = -1;
      li.addEventListener('click', () => {
        addCategoryTag(tab, cat);
        closeDropdown(tab);
      });
      listEl.appendChild(li);
    });
  }

  // Render category tags for a tab
  function renderTags(tab) {
    const container = categoryTags[tab];
    container.innerHTML = '';
    selectedCategories[tab].forEach(cat => {
      const tag = document.createElement('div');
      tag.className = 'category-tag';
      tag.textContent = cat;
      const removeBtn = document.createElement('span');
      removeBtn.className = 'remove-tag';
      removeBtn.textContent = '×';
      removeBtn.setAttribute('role', 'button');
      removeBtn.tabIndex = 0;
      removeBtn.setAttribute('aria-label', `Remove category ${cat}`);
      removeBtn.addEventListener('click', () => removeCategoryTag(tab, cat));
      removeBtn.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          removeCategoryTag(tab, cat);
        }
      });
      tag.appendChild(removeBtn);
      container.appendChild(tag);
    });
  }

  // Add category tag if not exists
  function addCategoryTag(tab, cat) {
    if (!selectedCategories[tab].includes(cat)) {
      selectedCategories[tab].push(cat);
      saveToStorage();
      renderTags(tab);
      refreshTabContent(tab);
    }
  }
  // Remove category tag
  function removeCategoryTag(tab, cat) {
    selectedCategories[tab] = selectedCategories[tab].filter(c => c !== cat);
    saveToStorage();
    renderTags(tab);
    refreshTabContent(tab);
  }
  // Clear all tags
  function clearCategoryTags(tab) {
    selectedCategories[tab] = [];
    saveToStorage();
    renderTags(tab);
    refreshTabContent(tab);
  }

  // Open dropdown
  function openDropdown(tab) {
    categoryDropdownLists[tab].classList.add('show');
    categoryDropdownToggles[tab].setAttribute('aria-expanded', 'true');
  }
  // Close dropdown
  function closeDropdown(tab) {
    categoryDropdownLists[tab].classList.remove('show');
    categoryDropdownToggles[tab].setAttribute('aria-expanded', 'false');
  }
  // Toggle dropdown
  function toggleDropdown(tab) {
    const list = categoryDropdownLists[tab];
    if (list.classList.contains('show')) closeDropdown(tab);
    else openDropdown(tab);
  }

  // Filter questions by categories for a tab (if no categories selected, return all)
  function filterQuestionsByCategory(tab, qs) {
    const cats = selectedCategories[tab];
    if (!cats.length) return qs;
    return qs.filter(q => cats.includes(q.category));
  }

  // Render all questions tab list with category filter
  function renderAllQuestions() {
    if (!questions.length) {
      allQuestionsDiv.innerHTML = '<p>No questions loaded.</p>';
      return;
    }
    const filtered = filterQuestionsByCategory('all', questions);
    if (!filtered.length) {
      allQuestionsDiv.innerHTML = '<p>No questions match the selected categories.</p>';
      return;
    }
    const fragment = document.createDocumentFragment();
    filtered.forEach(q => {
      const item = document.createElement('div');
      item.className = 'qa-item';
      item.setAttribute('role', 'listitem');
      item.innerHTML = `
        <div class="qa-q">
          <span>${q.id}. ${escapeHtml(q.question)}</span>
          <span class="qa-category-badge">${escapeHtml(q.category)}</span>
        </div>
        <div class="qa-a">Answer: ${escapeHtml(q.answer)}</div>`;
      fragment.appendChild(item);
    });
    allQuestionsDiv.innerHTML = '';
    allQuestionsDiv.appendChild(fragment);
  }

  // Pick questions for exam based on settings and categories
  function shuffle(arr) {
    for(let i = arr.length -1; i>0; i--) {
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function pickExamQuestions() {
    let pool;
    if (settings.repeatIncorrect && incorrectIds.length > 0) {
      pool = questions.filter(q => incorrectIds.includes(q.id));
    } else {
      pool = [...questions];
      if (settings.noRepeat) {
        pool = pool.filter(q => !recentIds.includes(q.id));
      }
    }
    pool = filterQuestionsByCategory('quiz', pool);
    if (pool.length === 0) {
      showToast('No questions available based on your settings.', 'error');
      return [];
    }
    shuffle(pool);
    return pool.slice(0, settings.qusCount);
  }

  // Render review list filtered by categories and filter type (all or incorrect or correct)
  function renderReview(filter = 'all') {
    let listIds;
    if (filter === 'incorrect') listIds = incorrectIds;
    else if (filter === 'correct') listIds = recentIds.filter(id => !incorrectIds.includes(id));
    else listIds = recentIds;

    listIds = filterQuestionsByCategory('recent', questions.filter(q => listIds.includes(q.id))).map(q => q.id);

    if (!listIds.length) {
      reviewList.innerHTML = '<p>No questions to display.</p>';
      return;
    }
    const listQs = listIds.map(id => questions.find(q => q.id === id)).filter(Boolean);
    const fragment = document.createDocumentFragment();
    listQs.forEach(q => {
      const item = document.createElement('div');
      item.className = 'review-item';
      item.setAttribute('role', 'listitem');
      const wasCorrect = !incorrectIds.includes(q.id);
      item.innerHTML = `
        <div class="qa-q">
          <span>${q.id}. ${escapeHtml(q.question)}</span>
          <span class="qa-category-badge">${escapeHtml(q.category)}</span>
        </div>
        <div>Answer: ${escapeHtml(q.answer)}</div>
        <div>Status: <span style="color:${wasCorrect ? 'green' : 'red'}">${wasCorrect ? 'Correct' : 'Incorrect'}</span></div>
      `;
      fragment.appendChild(item);
    });
    reviewList.innerHTML = '';
    reviewList.appendChild(fragment);
  }

  // Refresh content in a given tab (all, quiz, recent, help) after filtering or change
  function refreshTabContent(tab) {
    if (tab === 'all') renderAllQuestions();
    else if (tab === 'quiz') {
      if (examState && !examState.completed) renderExamQuestion();
    }
    else if (tab === 'recent') {
      const activeFilterBtn = document.querySelector('#review-filters .filter-btn.active');
      const filter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
      renderReview(filter);
    }
    // Help tab does not require refresh
  }

  // Update tab states (enable/disable, blur when exam running)
  function updateTabStates() {
    const isExamRunning = localStorage.getItem(STORAGE_KEYS.IS_EXAM_RUNNING) === 'true';
    if (isExamRunning) {
      tabButtons.all.classList.add('disabled');
      tabButtons.all.setAttribute('aria-disabled', 'true');
      tabButtons.recent.classList.add('disabled');
      tabButtons.recent.setAttribute('aria-disabled', 'true');

      if (tabButtons.all.classList.contains('active')) {
        tabContents.all.classList.add('blurred');
        tabContents.all.style.pointerEvents = 'none';
      } else {
        tabContents.all.classList.remove('blurred');
        tabContents.all.style.pointerEvents = '';
      }
      if (tabButtons.recent.classList.contains('active')) {
        tabContents.recent.classList.add('blurred');
        tabContents.recent.style.pointerEvents = 'none';
      } else {
        tabContents.recent.classList.remove('blurred');
        tabContents.recent.style.pointerEvents = '';
      }
    } else {
      tabButtons.all.classList.remove('disabled');
      tabButtons.all.removeAttribute('aria-disabled');
      tabButtons.recent.classList.remove('disabled');
      tabButtons.recent.removeAttribute('aria-disabled');
      tabContents.all.classList.remove('blurred');
      tabContents.all.style.pointerEvents = '';
      tabContents.recent.classList.remove('blurred');
      tabContents.recent.style.pointerEvents = '';
    }
  }

  // Switch tab
  function switchTab(tab) {
    for (const t in tabButtons) {
      const isActive = (t === tab);
      tabButtons[t].classList.toggle('active', isActive);
      tabButtons[t].setAttribute('aria-selected', isActive ? 'true' : 'false');
      tabContents[t].classList.toggle('active', isActive);
      tabContents[t].setAttribute('aria-hidden', isActive ? 'false' : 'true');
    }
    updateTabStates();
    if (tab === 'recent') {
      const activeFilterBtn = document.querySelector('#review-filters .filter-btn.active');
      const filter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
      renderReview(filter);
    }
  }

  // Prevent clicking disabled tabs
  tabButtons.all.addEventListener('click', e => {
    if (tabButtons.all.classList.contains('disabled')) {
      e.preventDefault();
      return;
    }
    switchTab('all');
  });
  tabButtons.quiz.addEventListener('click', () => switchTab('quiz'));
  tabButtons.recent.addEventListener('click', e => {
    if (tabButtons.recent.classList.contains('disabled')) {
      e.preventDefault();
      return;
    }
    switchTab('recent');
  });
  tabButtons.help.addEventListener('click', () => switchTab('help'));

  // Handle file upload
  function handleFile(file) {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        if (!validateQuizJson(data)) {
          showToast('Invalid JSON format. Must be array of {question, answer, category}.', 'error');
          return;
        }
        questions = assignIds(data);
        examState = null;
        recentIds = [];
        incorrectIds = [];
        localStorage.setItem(STORAGE_KEYS.IS_EXAM_RUNNING, 'false');
        saveToStorage();
        renderAllQuestions();
        renderReview();
        renderExamSettings();
        examArea.innerHTML = '';
        examResult.textContent = '';
        renderAllCategoriesDropdowns();
        ['all','quiz','recent'].forEach(tab => renderTags(tab));
        switchTab('all');
        showToast('JSON loaded successfully.', 'success');
        updateButtonsState();
        updateTabStates();
      } catch {
        showToast('Error parsing JSON file.', 'error');
      }
    };
    reader.readAsText(file);
  }
  uploadSection.addEventListener('dragover', e => {
    e.preventDefault();
    uploadSection.classList.add('dragover');
  });
  uploadSection.addEventListener('dragleave', e => {
    uploadSection.classList.remove('dragover');
  });
  uploadSection.addEventListener('drop', e => {
    e.preventDefault();
    uploadSection.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
      const file = e.dataTransfer.files[0];
      if (file.name.toLowerCase().endsWith('.json')) {
        handleFile(file);
      } else {
        showToast('Please upload a .json file', 'error');
      }
    }
  });
  fileInput.addEventListener('change', e => {
    if (fileInput.files.length) {
      const file = fileInput.files[0];
      if (file.name.toLowerCase().endsWith('.json')) {
        handleFile(file);
      } else {
        showToast('Please upload a .json file', 'error');
      }
    }
  });

  // Settings input listeners
  qusCountInput.addEventListener('input', () => {
    let val = parseInt(qusCountInput.value, 10);
    if (isNaN(val) || val < 1) val = 1;
    else if (val > 100) val = 100;
    qusCountInput.value = val;
    settings.qusCount = val;
    saveToStorage();
  });
  timePerQusInput.addEventListener('input', () => {
    let val = parseInt(timePerQusInput.value, 10);
    if (isNaN(val) || val < 1) val = 1;
    else if (val > 300) val = 300;
    timePerQusInput.value = val;
    settings.timePerQus = val;
    saveToStorage();
  });
  modeSelect.addEventListener('change', () => {
    settings.mode = modeSelect.value;
    saveToStorage();
  });
  noRepeatCheckbox.addEventListener('change', () => {
    settings.noRepeat = noRepeatCheckbox.checked;
    saveToStorage();
  });
  repeatIncorrectCheckbox.addEventListener('change', () => {
    settings.repeatIncorrect = repeatIncorrectCheckbox.checked;
    saveToStorage();
  });

  // Update buttons state
  function updateButtonsState() {
    const running = examState && !examState.completed;
    startExamBtn.disabled = running || questions.length === 0;
    skipQuestionBtn.style.display = running ? 'inline-block' : 'none';
    stopExamBtn.style.display = running ? 'inline-block' : 'none';
  }

  // Start exam
  startExamBtn.addEventListener('click', () => {
    if (questions.length === 0) {
      showToast('Load questions JSON first.', 'error');
      return;
    }
    settings.qusCount = parseInt(qusCountInput.value, 10);
    settings.timePerQus = parseInt(timePerQusInput.value, 10);
    settings.mode = modeSelect.value;
    settings.noRepeat = noRepeatCheckbox.checked;
    settings.repeatIncorrect = repeatIncorrectCheckbox.checked;
    saveToStorage();

    const selectedQs = pickExamQuestions();
    if (selectedQs.length === 0) return;

    examState = {
      questions: selectedQs,
      currentIdx: 0,
      answers: [],
      startTime: Date.now(),
      questionStartTime: Date.now(),
      times: [],
      completed: false
    };
    localStorage.setItem(STORAGE_KEYS.IS_EXAM_RUNNING, 'true');
    saveToStorage();
    switchTab('quiz');
    updateTabStates();
    renderExamQuestion();
    updateButtonsState();
  });

  // Render exam question
  function renderExamQuestion() {
    if (!examState) return;
    if (examState.currentIdx >= examState.questions.length) {
      finishExam();
      return;
    }
    const q = examState.questions[examState.currentIdx];
    examArea.innerHTML = `
      <div id="exam-timer" aria-live="polite" aria-atomic="true"></div>
      <div id="exam-question">
        <span>${q.id}. ${escapeHtml(q.question)}</span>
        <span class="qa-category-badge">${escapeHtml(q.category)}</span>
      </div>
      <input id="exam-answer" type="text" aria-label="Answer input" autocomplete="off" />
      <div style="margin-top:10px;">
        <button id="submit-answer">Submit Answer</button>
      </div>
    `;
    const timerDiv = document.getElementById('exam-timer');
    const answerInput = document.getElementById('exam-answer');
    const submitBtn = document.getElementById('submit-answer');
    answerInput.focus();

    if (settings.mode === 'timed') {
      timeLeft = settings.timePerQus;
      timerDiv.textContent = `Time left: ${timeLeft}s`;
      examTimer = setInterval(() => {
        timeLeft--;
        timerDiv.textContent = `Time left: ${timeLeft}s`;
        if (timeLeft <= 0) {
          clearInterval(examTimer);
          submitAnswer('');
        }
      }, 1000);
    } else {
      timerDiv.textContent = `No time limit mode`;
    }

    submitBtn.onclick = () => {
      clearInterval(examTimer);
      submitAnswer(answerInput.value.trim());
    };
    answerInput.onkeydown = e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitBtn.click();
      }
    };
  }

  // Submit answer
  function submitAnswer(ans) {
    if (!examState) return;
    const currentQ = examState.questions[examState.currentIdx];
    const correctAnswer = currentQ.answer.trim().toLowerCase();
    const userAnswer = ans.trim().toLowerCase();
    const isCorrect = userAnswer === correctAnswer;

    examState.answers.push({
      id: currentQ.id,
      question: currentQ.question,
      correctAnswer: currentQ.answer,
      userAnswer: ans,
      isCorrect: isCorrect
    });
    const questionTime = (Date.now() - examState.questionStartTime) / 1000;
    examState.times.push(questionTime);

    if (!recentIds.includes(currentQ.id)) {
      recentIds.unshift(currentQ.id);
      if (recentIds.length > 100) recentIds.pop();
    }
    if (!isCorrect) {
      if (!incorrectIds.includes(currentQ.id)) incorrectIds.push(currentQ.id);
    } else {
      const idx = incorrectIds.indexOf(currentQ.id);
      if (idx !== -1) incorrectIds.splice(idx, 1);
    }
    saveToStorage();

    examState.currentIdx++;
    examState.questionStartTime = Date.now();

    if (examState.currentIdx >= examState.questions.length) {
      finishExam();
    } else {
      renderExamQuestion();
    }
  }

  // Skip question (empty answer)
  skipQuestionBtn.addEventListener('click', () => {
    if (!examState || examState.completed) return;
    clearInterval(examTimer);
    submitAnswer('');
  });

  // Stop exam
  stopExamBtn.addEventListener('click', () => {
    if (!examState || examState.completed) return;
    clearInterval(examTimer);
    examState = null;
    localStorage.setItem(STORAGE_KEYS.IS_EXAM_RUNNING, 'false');
    saveToStorage();
    examArea.innerHTML = '';
    examResult.textContent = '';
    showToast('Exam stopped.', 'error');
    updateTabStates();
    updateButtonsState();
  });

  // Finish exam
  function finishExam() {
    if (!examState) return;
    examState.completed = true;
    saveToStorage();

    const total = examState.questions.length;
    const correct = examState.answers.filter(a => a.isCorrect).length;
    const totalTime = (Date.now() - examState.startTime) / 1000;
    const avgTime = examState.times.length ? (examState.times.reduce((a,b)=>a+b,0)/examState.times.length).toFixed(2) : 0;

    examArea.innerHTML = `<p>Exam Finished!</p>`;
    examResult.innerHTML = `
      Correct: ${correct} / ${total} <br/>
      Total Time: ${totalTime.toFixed(2)}s <br/>
      Average Time per Question: ${avgTime}s
    `;
    localStorage.setItem(STORAGE_KEYS.IS_EXAM_RUNNING, 'false');
    updateTabStates();
    switchTab('quiz');
    updateButtonsState();
  }

  // Review filters
  reviewFilters.forEach(btn => {
    btn.addEventListener('click', () => {
      reviewFilters.forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-pressed', 'false');
      });
      btn.classList.add('active');
      btn.setAttribute('aria-pressed', 'true');
      renderReview(btn.dataset.filter);
    });
  });

  // Render exam settings (inputs)
  function renderExamSettings() {
    qusCountInput.value = settings.qusCount;
    timePerQusInput.value = settings.timePerQus;
    modeSelect.value = settings.mode;
    noRepeatCheckbox.checked = settings.noRepeat;
    repeatIncorrectCheckbox.checked = settings.repeatIncorrect;
  }

  // Render all category dropdown lists for each tab
  function renderAllCategoriesDropdowns() {
    ['all', 'quiz', 'recent'].forEach(tab => {
      renderCategoryDropdownList(tab);
    });
  }

  // Initialize all category dropdown event listeners and tag clear buttons
  function initCategoryControls() {
    ['all', 'quiz', 'recent'].forEach(tab => {
      categoryDropdownToggles[tab].addEventListener('click', () => toggleDropdown(tab));
      clearCategoryBtns[tab].addEventListener('click', () => clearCategoryTags(tab));

      // Close dropdown if clicked outside
      document.addEventListener('click', (e) => {
        if (!categoryDropdownToggles[tab].contains(e.target) &&
            !categoryDropdownLists[tab].contains(e.target)) {
          closeDropdown(tab);
        }
      });
    });
  }

  // -- Help & Convert JSON Feature -- //

  // JSON syntax highlighting function
  function jsonSyntaxHighlight(json) {
    if (!json) return '';
    // Escape &, <, > to HTML entities
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    // Regex to highlight keys and values including strings with escaped quotes
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(?:\s*:)?|\b(true|false|null)\b|-?\d+(\.\d+)?([eE][+\-]?\d+)?)/g, function (match) {
      let cls = 'json-number';
      if (/^"/.test(match)) {
        if (/:$/.test(match)) {
          cls = 'json-key';
        } else {
          cls = 'json-string';
        }
      } else if (/true|false/.test(match)) {
        cls = 'json-boolean';
      } else if (/null/.test(match)) {
        cls = 'json-null';
      }
      return `<span class="${cls}">${match}</span>`;
    });
  }

  // Update JSON syntax highlighting in Help editor on input
  function updateHelpJsonHighlight() {
    const val = helpJsonTextarea.value;
    try {
      const parsed = JSON.parse(val);
      helpJsonHighlight.innerHTML = jsonSyntaxHighlight(val);
      helpJsonHighlight.classList.remove('json-error');
    } catch (e) {
      helpJsonHighlight.textContent = 'Invalid JSON';
      helpJsonHighlight.classList.add('json-error');
    }
  }

  // Fill Help key selects with unique keys from JSON data
  function fillHelpKeyOptions(jsonObj) {
    const keys = new Set();

    function recurseKeys(obj) {
      if (Array.isArray(obj)) {
        obj.forEach(item => recurseKeys(item));
      } else if (obj && typeof obj === 'object') {
        Object.keys(obj).forEach(k => {
          keys.add(k);
          recurseKeys(obj[k]);
        });
      }
    }
    recurseKeys(jsonObj);

    // Clear current options
    [helpCategoryKeySelect, helpQuestionKeySelect, helpAnswerKeySelect].forEach(select => {
      select.innerHTML = '';
    });

    keys.forEach(k => {
      const opt1 = document.createElement('option');
      opt1.value = k;
      opt1.textContent = k;
      helpCategoryKeySelect.appendChild(opt1.cloneNode(true));
      helpQuestionKeySelect.appendChild(opt1.cloneNode(true));
      helpAnswerKeySelect.appendChild(opt1.cloneNode(true));
    });
  }

  // Convert JSON based on user key mappings and load into questions list
  function convertAndLoadJson() {
    let raw;
    try {
      raw = JSON.parse(helpJsonTextarea.value);
    } catch {
      showToast('Invalid JSON in editor.', 'error');
      return;
    }
    const catKey = helpCategoryKeySelect.value;
    const useCatKeyAsVal = helpCategoryUseKey.checked;
    const qusKey = helpQuestionKeySelect.value;
    const useQusKeyAsVal = helpQuestionUseKey.checked;
    const ansKey = helpAnswerKeySelect.value;
    const useAnsKeyAsVal = helpAnswerUseKey.checked;

    // Flatten logic for different JSON formats (arrays or objects with keys)
    let arr = [];

    if (Array.isArray(raw)) {
      // Handle array of objects with category, question, answer or nested QA
      raw.forEach(item => {
        if (typeof item !== 'object') return;
        let category = '';
        let question = '';
        let answer = '';

        if (useCatKeyAsVal) {
          category = catKey;
        } else {
          category = item[catKey];
          if (category === undefined && Object.keys(item).length === 1 && Object.keys(item)[0] === catKey) {
            // In case of nested structure {category: [...]}
            category = catKey;
          }
        }

        if (useQusKeyAsVal) {
          question = qusKey;
        } else {
          question = item[qusKey];
          // Check if question key is nested inside another object like QA
          if (question === undefined) {
            for (const k in item) {
              if (typeof item[k] === 'object' && item[k] !== null && qusKey in item[k]) {
                question = item[k][qusKey];
                break;
              }
            }
          }
        }

        if (useAnsKeyAsVal) {
          answer = ansKey;
        } else {
          answer = item[ansKey];
          // Check nested answer key
          if (answer === undefined) {
            for (const k in item) {
              if (typeof item[k] === 'object' && item[k] !== null && ansKey in item[k]) {
                answer = item[k][ansKey];
                break;
              }
            }
          }
        }

        if (question !== undefined && answer !== undefined && category !== undefined) {
          arr.push({
            category,
            question,
            answer
          });
        }
      });
    } else if (typeof raw === 'object') {
      // Handle object with keys as categories
      Object.entries(raw).forEach(([key, value]) => {
        if (Array.isArray(value)) {
          value.forEach(qItem => {
            let question = '';
            let answer = '';
            if (useQusKeyAsVal) question = qusKey;
            else question = qItem[qusKey];
            if (useAnsKeyAsVal) answer = ansKey;
            else answer = qItem[ansKey];
            arr.push({
              category: useCatKeyAsVal ? catKey : key,
              question,
              answer
            });
          });
        }
      });
    }

    if (!arr.length) {
      showToast('No valid questions found after conversion.', 'error');
      return;
    }
    // Assign IDs and load questions
    questions = assignIds(arr);
    examState = null;
    recentIds = [];
    incorrectIds = [];
    localStorage.setItem(STORAGE_KEYS.IS_EXAM_RUNNING, 'false');
    saveToStorage();
    renderAllQuestions();
    renderReview();
    renderExamSettings();
    examArea.innerHTML = '';
    examResult.textContent = '';
    renderAllCategoriesDropdowns();
    ['all','quiz','recent'].forEach(tab => renderTags(tab));
    switchTab('all');
    showToast('JSON converted and loaded successfully.', 'success');
    updateButtonsState();
    updateTabStates();
  }

  // Help file input change
  helpFileInput.addEventListener('change', () => {
    const file = helpFileInput.files[0];
    if (!file) return;
    if (!file.name.toLowerCase().endsWith('.json')) {
      showToast('Please upload a .json file', 'error');
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      helpJsonTextarea.value = e.target.result;
      updateHelpJsonHighlight();
      fillHelpKeyOptions(JSON.parse(e.target.result));
    };
    reader.readAsText(file);
  });

  // Help textarea input event
  helpJsonTextarea.addEventListener('input', () => {
    updateHelpJsonHighlight();
    try {
      const val = helpJsonTextarea.value;
      const json = JSON.parse(val);
      fillHelpKeyOptions(json);
    } catch {
      // ignore parse errors on input
    }
  });

  // Convert button
  convertLoadBtn.addEventListener('click', () => {
    convertAndLoadJson();
  });

  // Initialization
  function init() {
    loadFromStorage();
    renderAllQuestions();
    renderReview();
    renderExamSettings();
    renderAllCategoriesDropdowns();
    initCategoryControls();
    ['all','quiz','recent'].forEach(tab => renderTags(tab));

    const isExamRunning = localStorage.getItem(STORAGE_KEYS.IS_EXAM_RUNNING) === 'true';
    if (isExamRunning && !examState) {
      localStorage.setItem(STORAGE_KEYS.IS_EXAM_RUNNING, 'false');
    }
    updateButtonsState();
    updateTabStates();
    switchTab(isExamRunning ? 'quiz' : 'all');

    // Init Help tab keys if empty
    if (helpCategoryKeySelect.options.length === 0) {
      helpCategoryKeySelect.innerHTML = '<option>category</option>';
      helpQuestionKeySelect.innerHTML = '<option>question</option>';
      helpAnswerKeySelect.innerHTML = '<option>answer</option>';
    }
    updateHelpJsonHighlight();
  }
  init();

})();
</script>
</body>
</html>
